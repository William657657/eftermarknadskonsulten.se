<!doctype html> 
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Health Check | EMK Sverige AB</title>
  <meta name="robots" content="noindex,nofollow" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="stylesheet" href="/assets/emk-theme.css?v=6" />
  <style>
    .ok{color:#057a55}.bad{color:#b91c1c}.warn{color:#b45309}
    .chip{border-radius:999px;padding:.2rem .6rem;background:#eef2f7;display:inline-block}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    td,th{padding:.5rem;border-bottom:1px solid rgba(0,0,0,.06);vertical-align:top}
    .muted{opacity:.8}
    .small{font-size:.9rem}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .wrap{max-width:920px;margin-inline:auto;padding:16px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Health Check</h1>
    <p class="muted">Snabbkontroll av sidor, assets, cookies/GA och säkerhets­headers. <button id="rerun" class="btn btn-outline btn-sm">Kör igen</button></p>

    <h2>Status för nyckel-URL:er</h2>
    <table id="urls"><thead><tr><th>Resurs</th><th>Status</th><th>Detaljer</th></tr></thead><tbody></tbody></table>

    <h2>Teknik & SEO-baskoll</h2>
    <table id="seo"><thead><tr><th>Test</th><th>Resultat</th><th>Detaljer</th></tr></thead><tbody></tbody></table>

    <h2>Säkerhets­headers</h2>
    <table id="sec"><thead><tr><th>Header</th><th>Resultat</th><th>Värde / Tips</th></tr></thead><tbody></tbody></table>

    <p class="small muted">Tips: Lägg till / uppdatera headers i din webbserver / CDN (exempel finns längre ner i min checklista till dig).</p>
  </div>

<script>
(async function(){
  const $u=document.querySelector('#urls tbody');
  const $s=document.querySelector('#seo tbody');
  const $h=document.querySelector('#sec tbody');
  document.getElementById('rerun').onclick=()=>location.reload();

  // ——— 1) URL-check (200/ok?) ———
  const paths=[
    '/', '/index.html', '/tjanster.html', '/plattform.html',
    '/om-oss.html', '/formular.html',
    '/integritet.html', '/cookies.html', '/villkor.html',
    '/assets/emk-theme.css', '/assets/customcolor_logo_customcolor_background.png',
    '/assets/customcolor_icon_customcolor_background.png'
  ];

  async function headOk(url){
    try{
      let res=await fetch(url,{method:'HEAD',cache:'no-store'});
      if(!res.ok){ // vissa hosts saknar HEAD -> prova GET
        res=await fetch(url,{method:'GET',cache:'no-store'});
      }
      return {ok:res.ok, status:res.status, statusText:res.statusText};
    }catch(e){ return {ok:false,status:0,statusText:String(e)}}
  }
  function row(tbody,a,b,c,cls=''){ const tr=document.createElement('tr');
    tr.innerHTML=`<td class="mono">${a}</td><td class="${cls}">${b}</td><td class="small muted">${c||''}</td>`;
    tbody.appendChild(tr);
  }

  await Promise.all(paths.map(async p=>{
    const r=await headOk(p);
    row($u, p, r.ok?'<span class="ok">PASS</span>':'<span class="bad">FAIL</span>', `${r.status} ${r.statusText}`);
  }));

  // ——— 2) SEO/Tech quick checks (på denna sida) ———
  function meta(name){const m=document.querySelector(`meta[name="${name}"]`);return m?m.content:''}
  const title=document.title||'';
  const desc=meta('description')||'';
  const ogt=document.querySelector('meta[property="og:title"]');
  const ogd=document.querySelector('meta[property="og:description"]');
  const ogi=document.querySelector('meta[property="og:image"]');

  row($s,'<b>Title</b>', title.length?'<span class="ok">OK</span>':'<span class="bad">SAKNAS</span>',
      `Längd: ${title.length} tecken`);
  row($s,'<b>Meta description</b>', (desc.length>=50&&desc.length<=170)?'<span class="ok">OK</span>':'<span class="warn">KORT/LÅNG</span>',
      desc?`Längd: ${desc.length}`:'Ingen description hittad');
  row($s,'<b>Open Graph</b>', (ogt&&ogd&&ogi)?'<span class="ok">OK</span>':'<span class="warn">DELAR SAKNAS</span>',
      `title:${!!ogt} description:${!!ogd} image:${!!ogi}`);

  // Cookie/GA4-läge (samma nyckel som på sajten)
  const consent=localStorage.getItem('emk_cookie_consent');
  const gaLoaded=typeof window.gtag==='function';
  let gaMsg='';
  let gaState='';
  if(consent==='accepted' && gaLoaded){gaState='<span class="ok">OK</span>';gaMsg='GA4 laddad efter samtycke.';}
  else if(consent==='accepted' && !gaLoaded){gaState='<span class="bad">FEL</span>';gaMsg='Samtycke finns men gtag saknas – kontrollera GA4-ID i cookiebannerns script.';}
  else if(consent!=='accepted' && gaLoaded){gaState='<span class="warn">AVVIKELSE</span>';gaMsg='gtag finns trots att samtycke inte är accepterat – se över cookie-scriptet.';}
  else {gaState='<span class="ok">BLOCKERAD</span>';gaMsg='Ingen spårning innan samtycke (bra).';}
  row($s,'<b>Cookies & GA4</b>', gaState, `consent="${consent||'none'}". ${gaMsg}`);

  // Mixed-content (http:-resurser)
  const badHrefs=[...document.querySelectorAll('[src],[href]')]
    .map(el=>el.getAttribute('src')||el.getAttribute('href'))
    .filter(Boolean).filter(u=>/^http:\/\//i.test(u));
  row($s,'<b>Mixed content</b>',badHrefs.length===0?'<span class="ok">OK</span>':'<span class="bad">HITTADE HTTP</span>',
      badHrefs.length?badHrefs.slice(0,5).join(', ') + (badHrefs.length>5?' …':''):'Endast https/relative.');

  // ——— 3) Säkerhetsheaders (hämtar ”/”) ———
  const res = await fetch('/', {method:'GET',cache:'no-store'});
  const headers = (k)=>res.headers.get(k)||'';

  const hsts=headers('strict-transport-security');
  row($h,'Strict-Transport-Security', hsts?'<span class="ok">OK</span>':'<span class="bad">SAKNAS</span>',
      hsts || 'Ex: max-age=31536000; includeSubDomains; preload');

  const csp=headers('content-security-policy');
  row($h,'Content-Security-Policy', csp?'<span class="ok">OK</span>':'<span class="warn">REKOMMENDERAS</span>',
      csp || "Sätt en CSP som tillåter 'self' och nödvändiga domäner.");

  const xcto=headers('x-content-type-options');
  row($h,'X-Content-Type-Options', xcto?'<span class="ok">OK</span>':'<span class="bad">SAKNAS</span>',
      xcto || 'nosniff');

  const refp=headers('referrer-policy');
  row($h,'Referrer-Policy', refp?'<span class="ok">OK</span>':'<span class="warn">REKOMMENDERAS</span>',
      refp || 'strict-origin-when-cross-origin');

  const pp=headers('permissions-policy') || headers('feature-policy');
  row($h,'Permissions-Policy', pp?'<span class="ok">OK</span>':'<span class="warn">REKOMMENDERAS</span>',
      pp || 'camera=(), microphone=(), geolocation=()');

})();
</script>
</body>
</html>
